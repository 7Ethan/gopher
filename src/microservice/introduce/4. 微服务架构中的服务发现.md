## gaishu

在现代基于云的微服务应用中，服务实例具有动态分配的网络位置。此外，由于自动扩缩、故障与升级，整组服务实例会动态变更。因此，客户端代码需要使用更精确的服务发现机制。

有两种主要的服务发现模式：客户端发现（client-side discovery）与服务端发现（server-side discovery）。

### 客户端发现模式

当使用客户端发现模式时，客户端负责确定可用服务实例的网络位置和请求负载均衡。客户端查询服务注册中心（service registry），它是可用服务实例的数据库。之后，客户端利用负载均衡算法选择一个可用的服务实例并发出请求。

服务实例的网络位置在服务注册中心启动时被注册。当实例终止时，它将从服务注册中心中移除。通常使用心跳机制周期性地刷新服务实例的注册信息。

>该模式相对比较简单，除了服务注册中心，没有其他移动部件。此外，由于客户端能发现可用的服务实例，因此可以实现智能的、特定于应用程序的负载均衡决策，比如使用一致性哈希。

>该模式的一个重要缺点是它将客户端与服务注册中心耦合在一起。必须为使用的每种编程语言和框架实现客户端服务发现逻辑。


### 服务端发现模式

与客户端发现一样，服务实例由服务注册中心注册与销毁,服务器间也可以处理服务发现.

>该模式的一大的优点是其把发现的细节从客户端抽象出来。客户端只需向负载均衡器发出请求。另外，如上所述，一些部署环境免费提供此功能。

>然而,除非负载均衡器由部署环境提供，否则需要引入负载均衡器这个高可用系统组件，并进行设置和管理。

### 服务注册中心

服务注册中心（service registry）是服务发现的一个关键部分。它是一个包含了服务实例网络位置的数据库。

**服务注册中心必须是高可用和最新的**。

服务注册中心:

* Netflix Eureka 

是一个很好的服务注册中心范例,它提供了一个用于注册和查询服务实例的 REST API。服务实例使用POST 请求注册其网络位置。它必须每隔 30 秒使用 PUT 请求来刷新其注册信息。通过使用 HTTP DELETE 请求或实例注册超时来移除
注册信息。

* etcd

一个用于共享配置和服务发现的高可用、分布式和一致的键值存储。使用了 etcd 的两个著名项目分别为 Kubernetes 和 Cloud Foundry。

* Consul
  
一个发现与配置服务工具。它提供了一个 API，可用于客户端注册与发现服务。Consul 可对服务进行健康检查，以确定服务的可用性。

* Apache ZooKeeper

一个被广泛应用于分布式应用程序的高性能协调服务。Apache ZooKeeper 最初是一个 Hadoop 子项目，但现在已经成为一个独立的顶级项目。

### 服务注册方式

#### 自注册模式

服务实例负责在服务注册中心**注册和注销自己**。此外，如果有必要，服务实例将通过发送心跳请求来防止其注
册信息过期。

好处是它相对简单，不需要任何其他系统组件。主要缺点是它将服务实例与服务注册中心耦合。

#### 第三方注册模式

服务实例不再负责向服务注册中心注册自己。相反，该工作将由被称为服务注册器（service registrar）的另一系统组件负责。

服务注册器通过轮询部署环境或订阅事件来跟踪运行实例集的变更情况。当它检测到一个新的可用服务实例时，它会将该实例注册到服务注册中心。此外，服务注册器可以注销终止的服务实例。

注册器**支持多种服务注册中心**，包括 etcd 和 Consul。

主要的好处是服务与服务注册中心之间解耦。缺点是，除非部署环境内置，否则同样需要引入这样一个高可用的系统组件，并进行设置和管理。

## 总结

服务发现的一个关键部分是服务注册中心。服务注册中心是一个可用服务实例的数据库。服务注册中心提供了管理 API 和查询 API 的功能。服务实例通过使用管理 API 从服务注册中心注册或者注销。系统组件使用查询 API 来发现可用的服务实例。

有两种主要的服务发现模式：客户端发现与服务端发现。在使用了客户端服务发现的系统中，客户端查询服务注册中心，选择一个可用实例并发出请求。在使用了服务端发现的系统中，客户端通过路由进行请求，路由将查询服务注册中心，并将请求转发到可用实例。

服务实例在服务注册中心中注册与注销有两种主要方式。一个是服务实例向服务注中心自我注册，即自注册模式。另一个是使用其他系统组件代表服务完成注册与注销，即第三方注册模式。

一个 HTTP 反向代理和负载均衡器（如 NGINX）也可以用作服务端发现负载均衡器。

